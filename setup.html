<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOHNBLOX - Account Setup</title>
    <style>
        /* Shared CSS from previous files */
        body { font-family: Verdana, Arial, sans-serif; background-color: #c9d4e4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #000; }
        .setup-container { background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: center; width: 400px; box-sizing: border-box; }
        .setup-container h1 { color: #0074cc; margin-bottom: 25px; font-size: 28px; }
        .setup-container label { display: block; text-align: left; margin-bottom: 5px; font-weight: bold; color: #333; }
        .setup-container input { width: calc(100% - 22px); padding: 12px; margin-bottom: 18px; border: 1px solid #a0a0a0; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .setup-container button { width: 100%; padding: 14px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; transition: background-color 0.2s; font-weight: bold; }
        .setup-container button:hover { background-color: #218838; }
        .message { margin-top: 15px; color: red; font-weight: bold; font-size: 14px; }
        .login-link { margin-top: 20px; font-size: 14px; }
        .login-link a { color: #0066cc; text-decoration: none; font-weight: bold; }
        .login-link a:hover { text-decoration: underline; }
    </style>
    <!-- Parse SDK CDN -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
</head>
<body>
    <div class="setup-container">
        <h1>Create Your JOHNBLOX Account</h1>
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="Choose a username" required>

        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Create a password" required>

        <label for="email">Email:</label> <!-- Email is used by Parse for signup/login -->
        <input type="email" id="email" placeholder="Your email address" required>

        <label for="birthday">Birthday (YYYY-MM-DD):</label>
        <input type="date" id="birthday">

        <button onclick="completeSetup()">Complete Setup</button>
        <p id="message" class="message"></p>
        <p class="login-link">Already have an account? <a href="login.html">Login here</a></p>
    </div>

    <script>
        // *** BACK4APP KEYS (Copied from your dashboard image) ***
        const APP_ID = 'UolRo1iE7vzgUI6J8OWGPrttMsCISDt4FrKtgfHWoCj';
        const JS_KEY = 'UpgDbqfWwBHyj8saGbCwWcCR5QU3ngG0zBb4Zbu8UHm';

        // Initialize Parse
        Parse.initialize(APP_ID, JS_KEY);
        Parse.serverURL = 'https://parseapi.back4app.com/'; // Standard Back4App Parse Server URL

        async function completeSetup() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value;
            const birthday = document.getElementById('birthday').value;
            const messageEl = document.getElementById('message');

            try {
                const user = new Parse.User();
                user.set("username", username);
                user.set("password", password);
                user.set("email", email);
                user.set("birthday", birthday || null); // Store birthday, null if empty

                // Set initial currency values
                user.set("johnbux", 0);
                user.set("jix", 0);

                await user.signUp(); // Sign up the user on Back4App

                // Simulate email sending after successful signup
                console.log(`--- EMAIL SIMULATION START (from Frontend for Back4App) ---`);
                console.log(`To: ${email}`);
                console.log(`From: noreply@johnblox.com (Simulated)`);
                console.log(`Subject: Welcome to JOHNBLOX!`);
                console.log(`Body: Hello ${username},\n\nYour JOHNBLOX account has been successfully set up!`);
                console.log(`--- EMAIL SIMULATION END ---`);
                // For real email via Back4App, you'd use SendGrid integrated with their Cloud Code.

                messageEl.textContent = "Account setup complete! Please log in.";
                messageEl.style.color = "green";
                setTimeout(() => { window.location.href = "login.html"; }, 2000); 

            } catch (error) {
                console.error("Setup failed:", error.message);
                let errorMessage = error.message;
                if (error.code === 202) { // Error 202 is "Username already taken" in Parse
                    errorMessage = "Username or Email already exists.";
                }
                // Other common Parse errors: 203 (Email already taken) - handled by 202 message for simplicity
                // 125 (Invalid Email Address)
                messageEl.textContent = `Setup failed: ${errorMessage}`;
                messageEl.style.color = "red";
            }
        }
    </script>
</body>
</html>
